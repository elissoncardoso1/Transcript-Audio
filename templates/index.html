<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcritor de Áudio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background-color: #e8f5e8;
            transform: scale(1.02);
        }

        .upload-area:hover {
            border-color: #0056b3;
            background-color: #e3f2fd;
        }

        .transcription-area {
            min-height: 300px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        .status-processing {
            background-color: #ffc107;
        }

        .status-completed {
            background-color: #28a745;
            animation: none;
        }

        .status-error {
            background-color: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .feature-card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .btn-custom {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .file-item .status-badge {
            font-size: 0.75rem;
        }

        .file-item.completed {
            background-color: #d4edda;
        }

        .file-item.processing {
            background-color: #fff3cd;
        }

        .file-item.error {
            background-color: #f8d7da;
        }

        .batch-transcription-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .batch-transcription-item .header {
            background-color: #e9ecef;
            padding: 10px 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .batch-transcription-item .content {
            padding: 15px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .model-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .model-card:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .model-card.selected {
            border-color: #28a745;
            background-color: #d4edda;
        }

        .model-card .model-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .model-card .model-size {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .current-model-indicator {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .current-model-indicator i {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .storage-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .storage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .storage-item:last-child {
            border-bottom: none;
        }

        .mode-toggle .btn {
            min-width: 150px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-gradient">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0">
                        <i class="fas fa-microphone-alt me-3"></i>
                        Transcritor de Áudio
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Converta arquivos de áudio em texto com alta precisão</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Cards de funcionalidades -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-file-audio fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Múltiplos Formatos</h5>
                        <p class="card-text">Suporte para MP3, WAV, OGG, OPUS, M4A e FLAC</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-brain fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Whisper.cpp</h5>
                        <p class="card-text">Transcrição com IA usando modelos otimizados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-download fa-3x text-info mb-3"></i>
                        <h5 class="card-title">Múltiplas Exportações</h5>
                        <p class="card-text">Exporte em TXT, JSON e Markdown</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Upload -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-upload me-2"></i>
                            Upload de Arquivo de Áudio
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Toggle de modo -->
                        <div class="mode-toggle btn-group" role="group">
                            <input type="radio" class="btn-check" name="uploadMode" id="singleMode" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="singleMode">
                                <i class="fas fa-file-audio me-1"></i>
                                Arquivo Único
                            </label>
                            <input type="radio" class="btn-check" name="uploadMode" id="batchMode" autocomplete="off">
                            <label class="btn btn-outline-primary" for="batchMode">
                                <i class="fas fa-layer-group me-1"></i>
                                Lote (Múltiplos)
                            </label>
                        </div>

                        <!-- Nome da sessão (visível apenas no modo lote) -->
                        <div id="sessionNameContainer" class="mb-3" style="display: none;">
                            <label for="sessionName" class="form-label">
                                <i class="fas fa-tag me-1"></i>
                                Nome da Sessão de Transcrição (opcional)
                            </label>
                            <input type="text" class="form-control" id="sessionName" 
                                   placeholder="Ex: Reunião 10/12, Entrevistas Projeto X, Aulas de Inglês..."
                                   maxlength="50">
                            <small class="text-muted">Este nome será usado para organizar todos os arquivos desta sessão</small>
                        </div>

                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-4x text-muted mb-3"></i>
                            <h5 id="uploadTitle">Arraste e solte seu arquivo de áudio aqui</h5>
                            <p class="text-muted">ou</p>
                            <button class="btn btn-primary btn-custom" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open me-2"></i>
                                <span id="selectBtnText">Selecionar Arquivo</span>
                            </button>
                            <input type="file" id="fileInput" accept="audio/*" style="display: none;">
                            <p class="text-muted mt-3 mb-0">
                                Formatos suportados: MP3, WAV, OGG, OPUS, M4A, FLAC (máx. 100MB por arquivo)
                            </p>
                        </div>

                        <!-- Informações do arquivo (modo único) -->
                        <div id="fileInfo" class="alert alert-info" style="display: none;">
                            <h6><i class="fas fa-info-circle me-2"></i>Arquivo carregado:</h6>
                            <div id="fileDetails"></div>
                        </div>

                        <!-- Lista de arquivos (modo lote) -->
                        <div id="batchFileInfo" class="alert alert-info" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    <span id="batchFileCount">0</span> arquivo(s) carregado(s)
                                </h6>
                                <span id="sessionNameBadge" class="badge bg-primary" style="display: none;"></span>
                            </div>
                            <div id="batchFileList" class="file-list"></div>
                        </div>

                        <!-- Configurações -->
                        <div id="settings" style="display: none;">
                            <hr>
                            <h5>Configurações de Transcrição</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="modelSelect" class="form-label">Modelo Whisper:</label>
                                    <select class="form-select" id="modelSelect">
                                        <option value="">Carregando modelos...</option>
                                    </select>
                                    <small class="text-muted" id="modelInfo">Modelos whisper.cpp</small>
                                </div>
                                <div class="col-md-4">
                                    <label for="languageSelect" class="form-label">Idioma:</label>
                                    <select class="form-select" id="languageSelect">
                                        <option value="auto">Detecção Automática</option>
                                        <option value="pt">Português</option>
                                        <option value="en">Inglês</option>
                                        <option value="es">Espanhol</option>
                                        <option value="fr">Francês</option>
                                        <option value="de">Alemão</option>
                                        <option value="it">Italiano</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-success btn-custom w-100" id="transcribeBtn">
                                        <i class="fas fa-play me-2"></i>
                                        Iniciar Transcrição
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Progresso -->
                        <div class="progress-container">
                            <!-- Indicador do modelo em uso durante transcrição -->
                            <div class="alert alert-info d-flex align-items-center mb-3" id="transcriptionModelIndicator">
                                <i class="fas fa-microchip me-2 fa-lg"></i>
                                <div>
                                    <small>Modelo em uso:</small>
                                    <strong id="transcriptionModelName">-</strong>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <span class="status-indicator status-processing"></span>
                                <span id="statusText">Processando transcrição...</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>

                        <!-- Resultado da Transcrição -->
                        <div id="transcriptionResult" style="display: none;">
                            <hr>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>
                                    <i class="fas fa-file-alt me-2"></i>
                                    Resultado da Transcrição
                                    <span id="resultModelBadge" class="badge bg-info ms-2" style="font-size: 0.7rem;"></span>
                                </h5>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyText()">
                                        <i class="fas fa-copy me-1"></i>
                                        Copiar
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearText()">
                                        <i class="fas fa-trash me-1"></i>
                                        Limpar
                                    </button>
                                </div>
                            </div>
                            <div class="transcription-area" id="transcriptionText"></div>

                            <!-- Opções de Exportação -->
                            <div class="mt-3">
                                <h6>Exportar como:</h6>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-primary" onclick="exportText('txt')">
                                        <i class="fas fa-file-alt me-1"></i>
                                        TXT
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="exportText('json')">
                                        <i class="fas fa-code me-1"></i>
                                        JSON
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="exportText('md')">
                                        <i class="fab fa-markdown me-1"></i>
                                        Markdown
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Resultado da Transcrição em Lote -->
                        <div id="batchTranscriptionResult" style="display: none;">
                            <hr>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>
                                    <i class="fas fa-layer-group me-2"></i>
                                    Resultados da Transcrição em Lote
                                    <span id="batchSessionNameResult" class="badge bg-primary ms-2" style="display: none;"></span>
                                </h5>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyAllBatchText()">
                                        <i class="fas fa-copy me-1"></i>
                                        Copiar Todos
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearBatchResults()">
                                        <i class="fas fa-trash me-1"></i>
                                        Limpar
                                    </button>
                                </div>
                            </div>
                            <div id="batchTranscriptionList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modelos Disponíveis -->
        <div class="row mt-4">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-brain me-2"></i>
                            Modelos Whisper Disponíveis
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadModels()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Indicador do modelo em uso -->
                        <div id="currentModelIndicator" class="current-model-indicator" style="display: none;">
                            <i class="fas fa-microchip"></i>
                            <div>
                                <small>Modelo Selecionado</small>
                                <div id="currentModelName" class="fw-bold"></div>
                            </div>
                        </div>
                        
                        <div id="modelsGrid" class="row">
                            <p class="text-muted">Carregando modelos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Histórico e Gerenciamento -->
        <div class="row mt-4">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Histórico de Transcrições
                        </h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmClearHistory()">
                            <i class="fas fa-trash me-1"></i>
                            Limpar Histórico
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="historyContent">
                            <p class="text-muted">Carregando histórico...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gerenciamento de Armazenamento -->
        <div class="row mt-4 mb-4">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-hdd me-2"></i>
                            Gerenciamento de Armazenamento
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="storage-info" id="storageInfo">
                            <div class="storage-item">
                                <span><i class="fas fa-upload me-2 text-primary"></i>Uploads</span>
                                <span id="uploadsInfo">Carregando...</span>
                            </div>
                            <div class="storage-item">
                                <span><i class="fas fa-file-alt me-2 text-success"></i>Transcrições</span>
                                <span id="transcriptionsInfo">Carregando...</span>
                            </div>
                            <div class="storage-item fw-bold">
                                <span><i class="fas fa-database me-2 text-info"></i>Total</span>
                                <span id="totalStorageInfo">Carregando...</span>
                            </div>
                        </div>
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-outline-warning" onclick="confirmClearUploads()">
                                <i class="fas fa-eraser me-1"></i>
                                Limpar Uploads
                            </button>
                            <button class="btn btn-outline-danger" onclick="confirmClearAll()">
                                <i class="fas fa-trash-alt me-1"></i>
                                Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Confirmar Ação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Tem certeza que deseja continuar?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmModalBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast de notificações -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-bell me-2"></i>
                <strong class="me-auto">Notificação</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTranscription = '';
        let transcriptionInterval = null;
        let batchMode = false;
        let currentBatchId = null;
        let batchTranscriptions = [];

        // Upload area events
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        // Mode toggle
        document.getElementById('singleMode').addEventListener('change', () => {
            batchMode = false;
            updateUploadMode();
        });

        document.getElementById('batchMode').addEventListener('change', () => {
            batchMode = true;
            updateUploadMode();
        });

        function updateUploadMode() {
            const fileInput = document.getElementById('fileInput');
            const sessionNameContainer = document.getElementById('sessionNameContainer');
            const uploadTitle = document.getElementById('uploadTitle');
            const selectBtnText = document.getElementById('selectBtnText');

            if (batchMode) {
                fileInput.multiple = true;
                sessionNameContainer.style.display = 'block';
                uploadTitle.textContent = 'Arraste e solte seus arquivos de áudio aqui';
                selectBtnText.textContent = 'Selecionar Arquivos';
            } else {
                fileInput.multiple = false;
                sessionNameContainer.style.display = 'none';
                uploadTitle.textContent = 'Arraste e solte seu arquivo de áudio aqui';
                selectBtnText.textContent = 'Selecionar Arquivo';
            }

            // Limpar seleções anteriores
            fileInput.value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('batchFileInfo').style.display = 'none';
            document.getElementById('settings').style.display = 'none';
        }

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                if (batchMode || files.length > 1) {
                    // Se arrastar múltiplos arquivos, ativar modo lote automaticamente
                    if (files.length > 1 && !batchMode) {
                        document.getElementById('batchMode').checked = true;
                        batchMode = true;
                        updateUploadMode();
                    }
                    handleBatchUpload(files);
                } else {
                    handleFileUpload(files[0]);
                }
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                if (batchMode) {
                    handleBatchUpload(e.target.files);
                } else {
                    handleFileUpload(e.target.files[0]);
                }
            }
        });

        function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('audio_file', file);

            // Mostrar loading
            showNotification('Enviando arquivo...', 'info');

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'danger');
                } else {
                    showNotification('Arquivo enviado com sucesso!', 'success');
                    showFileInfo(file, data.filename);
                    document.getElementById('settings').style.display = 'block';
                }
            })
            .catch(error => {
                showNotification('Erro ao enviar arquivo: ' + error.message, 'danger');
            });
        }

        function handleBatchUpload(files) {
            const formData = new FormData();
            const sessionName = document.getElementById('sessionName').value.trim();

            for (let i = 0; i < files.length; i++) {
                formData.append('audio_files', files[i]);
            }
            formData.append('session_name', sessionName);

            // Mostrar loading
            showNotification(`Enviando ${files.length} arquivo(s)...`, 'info');

            fetch('/upload_batch', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'danger');
                    if (data.details) {
                        console.error('Detalhes:', data.details);
                    }
                } else {
                    showNotification(data.message, 'success');
                    currentBatchId = data.batch_id;
                    showBatchFileInfo(data.files, data.session_name, data.errors);
                    document.getElementById('settings').style.display = 'block';
                }
            })
            .catch(error => {
                showNotification('Erro ao enviar arquivos: ' + error.message, 'danger');
            });
        }

        function showFileInfo(file, filename) {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');

            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);

            fileDetails.innerHTML = `
                <strong>Nome:</strong> ${filename}<br>
                <strong>Tamanho:</strong> ${sizeInMB} MB<br>
                <strong>Tipo:</strong> ${file.type}
            `;

            fileInfo.style.display = 'block';
            document.getElementById('batchFileInfo').style.display = 'none';
        }

        function showBatchFileInfo(files, sessionName, errors) {
            const batchFileInfo = document.getElementById('batchFileInfo');
            const batchFileList = document.getElementById('batchFileList');
            const batchFileCount = document.getElementById('batchFileCount');
            const sessionNameBadge = document.getElementById('sessionNameBadge');

            batchFileCount.textContent = files.length;

            if (sessionName) {
                sessionNameBadge.textContent = sessionName;
                sessionNameBadge.style.display = 'inline';
            } else {
                sessionNameBadge.style.display = 'none';
            }

            let html = '';
            files.forEach(file => {
                html += `
                    <div class="file-item" data-filename="${file}">
                        <span><i class="fas fa-file-audio me-2"></i>${file}</span>
                        <span class="badge bg-secondary status-badge">Aguardando</span>
                    </div>
                `;
            });

            if (errors && errors.length > 0) {
                errors.forEach(error => {
                    html += `
                        <div class="file-item error">
                            <span><i class="fas fa-exclamation-triangle me-2 text-danger"></i>${error}</span>
                        </div>
                    `;
                });
            }

            batchFileList.innerHTML = html;
            batchFileInfo.style.display = 'block';
            document.getElementById('fileInfo').style.display = 'none';
        }

        // Variáveis para modelos
        let selectedModelPath = '';
        let selectedModelName = '';
        let modelsData = null;

        // Carregar modelos
        function loadModels() {
            fetch('/models')
                .then(response => response.json())
                .then(data => {
                    modelsData = data;
                    const modelSelect = document.getElementById('modelSelect');
                    const modelInfo = document.getElementById('modelInfo');
                    const modelsGrid = document.getElementById('modelsGrid');
                    const currentModelIndicator = document.getElementById('currentModelIndicator');
                    const currentModelName = document.getElementById('currentModelName');

                    if (data.error) {
                        modelSelect.innerHTML = '<option value="">Erro ao carregar modelos</option>';
                        modelInfo.textContent = data.error;
                        modelsGrid.innerHTML = `<div class="col-12"><p class="text-danger">${data.error}</p></div>`;
                        return;
                    }

                    // Preencher select de modelos
                    modelSelect.innerHTML = '';
                    Object.keys(data.models).forEach(modelName => {
                        const option = document.createElement('option');
                        option.value = data.models[modelName];
                        option.textContent = modelName.charAt(0).toUpperCase() + modelName.slice(1);
                        if (modelName === data.current_model) {
                            option.selected = true;
                            selectedModelPath = data.models[modelName];
                            selectedModelName = modelName;
                        }
                        modelSelect.appendChild(option);
                    });

                    modelInfo.textContent = `Modelo atual: ${data.current_model}`;

                    // Mostrar indicador do modelo atual
                    currentModelIndicator.style.display = 'flex';
                    currentModelName.textContent = selectedModelName.charAt(0).toUpperCase() + selectedModelName.slice(1);

                    // Criar grid de modelos com informações
                    let gridHtml = '';
                    const modelOrder = ['tiny', 'base', 'small', 'medium', 'large', 'large-v2', 'large-v3'];
                    const sortedModels = Object.keys(data.models_info).sort((a, b) => {
                        const indexA = modelOrder.indexOf(a);
                        const indexB = modelOrder.indexOf(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });

                    sortedModels.forEach(modelName => {
                        const info = data.models_info[modelName];
                        const isSelected = modelName === selectedModelName;
                        const modelDisplayName = modelName.charAt(0).toUpperCase() + modelName.slice(1);
                        
                        // Definir cor baseada no tamanho
                        let sizeClass = 'text-success';
                        if (info.size_mb > 500) sizeClass = 'text-warning';
                        if (info.size_mb > 1500) sizeClass = 'text-danger';

                        gridHtml += `
                            <div class="col-md-4 col-sm-6 mb-2">
                                <div class="model-card ${isSelected ? 'selected' : ''}" 
                                     data-model-path="${info.path}" 
                                     data-model-name="${modelName}"
                                     onclick="selectModel('${modelName}', '${info.path}')">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="model-name">
                                            ${isSelected ? '<i class="fas fa-check-circle text-success me-2"></i>' : ''}
                                            ${modelDisplayName}
                                        </div>
                                        ${isSelected ? '<span class="badge bg-success">Em uso</span>' : ''}
                                    </div>
                                    <div class="model-size ${sizeClass}">
                                        <i class="fas fa-weight me-1"></i>${info.size_display}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    if (gridHtml === '') {
                        gridHtml = '<div class="col-12"><p class="text-muted">Nenhum modelo encontrado. Baixe modelos usando o script de download do whisper.cpp.</p></div>';
                    }

                    modelsGrid.innerHTML = gridHtml;
                })
                .catch(error => {
                    console.error('Erro ao carregar modelos:', error);
                    document.getElementById('modelSelect').innerHTML =
                        '<option value="">Erro ao carregar modelos</option>';
                    document.getElementById('modelsGrid').innerHTML =
                        '<div class="col-12"><p class="text-danger">Erro ao carregar modelos</p></div>';
                });
        }

        function selectModel(modelName, modelPath) {
            selectedModelName = modelName;
            selectedModelPath = modelPath;

            // Atualizar select
            const modelSelect = document.getElementById('modelSelect');
            for (let option of modelSelect.options) {
                if (option.value === modelPath) {
                    option.selected = true;
                    break;
                }
            }

            // Atualizar indicador
            document.getElementById('currentModelName').textContent = 
                modelName.charAt(0).toUpperCase() + modelName.slice(1);

            // Atualizar cards
            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.remove('selected');
                const nameDiv = card.querySelector('.model-name');
                nameDiv.innerHTML = nameDiv.textContent.trim();
                const badge = card.querySelector('.badge');
                if (badge) badge.remove();
            });

            const selectedCard = document.querySelector(`.model-card[data-model-name="${modelName}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                const nameDiv = selectedCard.querySelector('.model-name');
                nameDiv.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${nameDiv.textContent.trim()}`;
                const cardContent = selectedCard.querySelector('.d-flex');
                cardContent.insertAdjacentHTML('beforeend', '<span class="badge bg-success">Em uso</span>');
            }

            showNotification(`Modelo ${modelName} selecionado`, 'success');
        }

        // Atualizar o modelo selecionado quando mudar no select
        document.getElementById('modelSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const modelPath = this.value;
            
            // Encontrar o nome do modelo pelo path
            if (modelsData && modelsData.models) {
                for (const [name, path] of Object.entries(modelsData.models)) {
                    if (path === modelPath) {
                        selectModel(name, path);
                        break;
                    }
                }
            }
        });

        // Variável para armazenar o modelo usado na transcrição atual
        let currentTranscriptionModel = '';

        // Transcrição
        document.getElementById('transcribeBtn').addEventListener('click', () => {
            const language = document.getElementById('languageSelect').value;
            const model = document.getElementById('modelSelect').value;

            // Atualizar indicador do modelo em uso
            currentTranscriptionModel = selectedModelName || 'base';
            document.getElementById('transcriptionModelName').textContent = 
                currentTranscriptionModel.charAt(0).toUpperCase() + currentTranscriptionModel.slice(1);

            document.getElementById('transcribeBtn').disabled = true;
            document.querySelector('.progress-container').style.display = 'block';
            document.getElementById('statusText').textContent = 'Iniciando transcrição...';

            if (batchMode && currentBatchId) {
                // Transcrição em lote
                fetch('/transcribe_batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        language: language, 
                        model: model,
                        batch_id: currentBatchId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'danger');
                        resetTranscriptionUI();
                    } else {
                        showNotification('Transcrição em lote iniciada!', 'success');
                        checkBatchStatus();
                    }
                })
                .catch(error => {
                    showNotification('Erro ao iniciar transcrição: ' + error.message, 'danger');
                    resetTranscriptionUI();
                });
            } else {
                // Transcrição única
                fetch('/transcribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ language: language, model: model })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'danger');
                        resetTranscriptionUI();
                    } else {
                        showNotification('Transcrição iniciada!', 'success');
                        checkTranscriptionStatus();
                    }
                })
                .catch(error => {
                    showNotification('Erro ao iniciar transcrição: ' + error.message, 'danger');
                    resetTranscriptionUI();
                });
            }
        });

        function checkBatchStatus() {
            transcriptionInterval = setInterval(() => {
                fetch(`/batch_status/${currentBatchId}`)
                .then(response => response.json())
                .then(data => {
                    // Atualizar status dos arquivos
                    updateBatchFileStatus(data.files);
                    
                    // Atualizar texto de progresso
                    document.getElementById('statusText').textContent = 
                        `Processando ${data.current_file}/${data.total} arquivos...`;

                    if (data.status === 'completed') {
                        clearInterval(transcriptionInterval);
                        batchTranscriptions = data.transcriptions;
                        showBatchTranscriptionResult(data.transcriptions, data.session_name);
                        showNotification(`Transcrição concluída! ${data.completed}/${data.total} arquivos processados.`, 'success');
                        resetTranscriptionUI();
                        loadHistory();
                    } else if (data.status === 'error') {
                        clearInterval(transcriptionInterval);
                        showNotification('Erro na transcrição em lote', 'danger');
                        resetTranscriptionUI();
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                });
            }, 2000);
        }

        function updateBatchFileStatus(files) {
            files.forEach(file => {
                const fileItem = document.querySelector(`.file-item[data-filename="${file.name}"]`);
                if (fileItem) {
                    const badge = fileItem.querySelector('.status-badge');
                    
                    fileItem.classList.remove('pending', 'processing', 'completed', 'error');
                    
                    if (file.status === 'processing') {
                        fileItem.classList.add('processing');
                        badge.className = 'badge bg-warning status-badge';
                        badge.textContent = 'Processando...';
                    } else if (file.status === 'completed') {
                        fileItem.classList.add('completed');
                        badge.className = 'badge bg-success status-badge';
                        badge.textContent = 'Concluído';
                    } else if (file.status === 'error') {
                        fileItem.classList.add('error');
                        badge.className = 'badge bg-danger status-badge';
                        badge.textContent = 'Erro';
                    }
                }
            });
        }

        function showBatchTranscriptionResult(transcriptions, sessionName) {
            const resultDiv = document.getElementById('batchTranscriptionResult');
            const listDiv = document.getElementById('batchTranscriptionList');
            const sessionNameBadge = document.getElementById('batchSessionNameResult');

            if (sessionName) {
                sessionNameBadge.textContent = sessionName;
                sessionNameBadge.style.display = 'inline';
            } else {
                sessionNameBadge.style.display = 'none';
            }

            let html = '';
            transcriptions.forEach((trans, index) => {
                html += `
                    <div class="batch-transcription-item">
                        <div class="header d-flex justify-content-between align-items-center" 
                             onclick="toggleTranscription(${index})">
                            <span>
                                <i class="fas fa-file-audio me-2"></i>
                                ${index + 1}. ${trans.filename}
                            </span>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" 
                                        onclick="event.stopPropagation(); copySingleBatchText(${index})">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <i class="fas fa-chevron-down" id="chevron-${index}"></i>
                            </div>
                        </div>
                        <div class="content" id="content-${index}">${trans.text}</div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            document.getElementById('transcriptionResult').style.display = 'none';
        }

        function toggleTranscription(index) {
            const content = document.getElementById(`content-${index}`);
            const chevron = document.getElementById(`chevron-${index}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.classList.remove('fa-chevron-right');
                chevron.classList.add('fa-chevron-down');
            } else {
                content.style.display = 'none';
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-right');
            }
        }

        function copySingleBatchText(index) {
            if (batchTranscriptions[index]) {
                navigator.clipboard.writeText(batchTranscriptions[index].text).then(() => {
                    showNotification('Texto copiado para a área de transferência!', 'success');
                });
            }
        }

        function copyAllBatchText() {
            const allText = batchTranscriptions.map((trans, i) => 
                `=== ${i + 1}. ${trans.filename} ===\n\n${trans.text}`
            ).join('\n\n---\n\n');
            
            navigator.clipboard.writeText(allText).then(() => {
                showNotification('Todos os textos copiados para a área de transferência!', 'success');
            });
        }

        function clearBatchResults() {
            batchTranscriptions = [];
            document.getElementById('batchTranscriptionResult').style.display = 'none';
            document.getElementById('batchTranscriptionList').innerHTML = '';
        }

        function checkTranscriptionStatus() {
            transcriptionInterval = setInterval(() => {
                fetch('/transcription_status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'completed') {
                        clearInterval(transcriptionInterval);
                        showTranscriptionResult(data.text);
                        showNotification('Transcrição concluída!', 'success');
                        resetTranscriptionUI();
                        loadHistory();
                    } else if (data.status === 'error') {
                        clearInterval(transcriptionInterval);
                        showNotification('Erro na transcrição: ' + data.error, 'danger');
                        resetTranscriptionUI();
                    } else if (data.status === 'processing') {
                        document.getElementById('statusText').textContent = 'Processando transcrição...';
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                });
            }, 2000);
        }

        function showTranscriptionResult(text) {
            currentTranscription = text;
            document.getElementById('transcriptionText').textContent = text;
            document.getElementById('transcriptionResult').style.display = 'block';
            document.getElementById('batchTranscriptionResult').style.display = 'none';
            
            // Mostrar badge do modelo usado
            const resultModelBadge = document.getElementById('resultModelBadge');
            if (currentTranscriptionModel) {
                resultModelBadge.textContent = `Modelo: ${currentTranscriptionModel.charAt(0).toUpperCase() + currentTranscriptionModel.slice(1)}`;
                resultModelBadge.style.display = 'inline';
            }
        }

        function resetTranscriptionUI() {
            document.getElementById('transcribeBtn').disabled = false;
            document.querySelector('.progress-container').style.display = 'none';
        }

        // Export functions
        function exportText(format) {
            const language = document.getElementById('languageSelect').value;

            fetch('/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: currentTranscription,
                    format: format,
                    language: language
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                a.download = `transcription_${timestamp}.${format}`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification(`Arquivo exportado como ${format.toUpperCase()}`, 'success');
            })
            .catch(error => {
                showNotification('Erro ao exportar: ' + error.message, 'danger');
            });
        }

        function copyText() {
            navigator.clipboard.writeText(currentTranscription).then(() => {
                showNotification('Texto copiado para a área de transferência!', 'success');
            });
        }

        function clearText() {
            currentTranscription = '';
            document.getElementById('transcriptionText').textContent = '';
            document.getElementById('transcriptionResult').style.display = 'none';
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const toastEl = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // History
        function loadHistory() {
            fetch('/history')
            .then(response => response.json())
            .then(data => {
                const historyContent = document.getElementById('historyContent');

                if (data.length === 0) {
                    historyContent.innerHTML = '<p class="text-muted">Nenhuma transcrição encontrada.</p>';
                } else {
                    let html = '<div class="list-group">';
                    data.forEach(item => {
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${item.filename}</h6>
                                    <small>${item.created}</small>
                                </div>
                                <small>Tamanho: ${(item.size / 1024).toFixed(1)} KB</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    historyContent.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar histórico:', error);
                document.getElementById('historyContent').innerHTML =
                    '<p class="text-danger">Erro ao carregar histórico.</p>';
            });
        }

        // Storage management
        function loadStorageInfo() {
            fetch('/storage_info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('uploadsInfo').textContent = 
                    `${data.uploads.count} arquivo(s) - ${data.uploads.size_display}`;
                document.getElementById('transcriptionsInfo').textContent = 
                    `${data.transcriptions.count} arquivo(s) - ${data.transcriptions.size_display}`;
                document.getElementById('totalStorageInfo').textContent = 
                    data.total.size_display;
            })
            .catch(error => {
                console.error('Erro ao carregar info de armazenamento:', error);
            });
        }

        let confirmCallback = null;

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = message;
            confirmCallback = callback;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        document.getElementById('confirmModalBtn').addEventListener('click', function() {
            if (confirmCallback) {
                confirmCallback();
            }
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        });

        function confirmClearUploads() {
            showConfirmModal(
                'Limpar Uploads',
                'Tem certeza que deseja remover todos os arquivos de upload? Esta ação não pode ser desfeita.',
                clearUploads
            );
        }

        function confirmClearHistory() {
            showConfirmModal(
                'Limpar Histórico',
                'Tem certeza que deseja remover todo o histórico de transcrições? Esta ação não pode ser desfeita.',
                clearHistory
            );
        }

        function confirmClearAll() {
            showConfirmModal(
                'Limpar Tudo',
                'Tem certeza que deseja remover todos os uploads e transcrições? Esta ação não pode ser desfeita.',
                clearAll
            );
        }

        function clearUploads() {
            fetch('/clear_uploads', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadStorageInfo();
                    // Resetar UI de upload
                    document.getElementById('fileInfo').style.display = 'none';
                    document.getElementById('batchFileInfo').style.display = 'none';
                    document.getElementById('settings').style.display = 'none';
                } else {
                    showNotification(data.error, 'danger');
                }
            })
            .catch(error => {
                showNotification('Erro ao limpar uploads: ' + error.message, 'danger');
            });
        }

        function clearHistory() {
            fetch('/clear_history', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadHistory();
                    loadStorageInfo();
                } else {
                    showNotification(data.error, 'danger');
                }
            })
            .catch(error => {
                showNotification('Erro ao limpar histórico: ' + error.message, 'danger');
            });
        }

        function clearAll() {
            clearUploads();
            setTimeout(() => {
                clearHistory();
            }, 500);
        }

        // Load history on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            loadModels();
            loadStorageInfo();
        });
    </script>
</body>
</html>